#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include "xil_io.h"
#include "xparameters.h"
#include "xil_types.h"
#include "xil_cache.h"
#include "ff.h"
#include "xdevcfg.h"
#include "sleep.h"
#include "sd_card.h"


#define VDMA_BASEADDR XPAR_AXI_VDMA_0_BASEADDR
#define VDMA_BUFFER_0 0x08000000
#define STRIDE 1280
#define HSIZE  1280
#define VSIZE  720
#define VIDEO_LENTH ( HSIZE*VSIZE)
#define BUF_SIZE VIDEO_LENTH*3

#define FILE_NAME "zynq.txt"                //定义文件名
static FATFS fatfs;                         //文件系统

const char src_str[30] = "www.openedv.com"; //定义文本内容
  void vdma_init()
  {
	  int i;
	  for (i = 0; i <VIDEO_LENTH ; i++)
	  {
		  Xil_Out32( VDMA_BUFFER_0 + i*4 , 0);
	  }
	Xil_DCacheFlush();
  	Xil_Out32(VDMA_BASEADDR,0x1);//开启vdma
    Xil_Out32(VDMA_BASEADDR+0x5c,VDMA_BUFFER_0);//设置vdma映射内存起始地址
  	Xil_Out32(VDMA_BASEADDR+0x58,STRIDE*3);//设置每行的
	Xil_Out32(VDMA_BASEADDR+0x54,HSIZE*3);//设置每行的像素宽度=像素数x像素字节数
  	Xil_Out32(VDMA_BASEADDR+0x50,VSIZE);//设置显示器高度像素数;
  	xil_printf("vdma初始化完成\r\n");
  }



int main(void)
{
	int len;

	init_sd_card();
	len = strlen(src_str);

	//SD 卡写数据
	 sd_write_data(FILE_NAME,(u32)src_str,len);
	 //SD 卡读数据
	 sd_read_data(FILE_NAME,(u32)dest_str,len);

	 //比较写入的字符串和读出的字符串是否相等
	 if (strcmp(src_str, dest_str) == 0)
	 xil_printf("src_str is equal to dest_str,SD card test success!\n");
	 else
	 xil_printf("src_str is not equal to dest_str,SD card test failed!\n");

	 return 0;
}
